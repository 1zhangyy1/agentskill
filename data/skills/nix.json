{
  "id": "c2c234d4c3032168",
  "slug": "nix",
  "name": "Nix",
  "description": "",
  "author": "richardgill",
  "authorAvatar": "https://avatars.githubusercontent.com/u/6640874?v=4",
  "repoUrl": "https://github.com/richardgill/nix",
  "repoFullName": "richardgill/nix",
  "stars": 24,
  "forks": 1,
  "category": "other",
  "categories": [
    "other"
  ],
  "tags": [],
  "tier": 2,
  "status": "active",
  "createdAt": "2025-09-27T08:00:50Z",
  "updatedAt": "2025-12-12T09:17:56Z",
  "lastCommitAt": "2025-12-12T09:17:59Z",
  "source": "github-search",
  "collectedAt": "2025-12-13T03:24:31.843Z",
  "authorUrl": "https://github.com/richardgill",
  "license": "MIT",
  "readme": "My opinionated Nix config inspired by [Omarchy](https://omarchy.org/)'s system choices and [chenglab](https://github.com/eh8/chenglab)'s configuration structure.\n\nPragmatic Nix: Simple config with plain `.conf` and `.json` files. Uses `.nix` features when they provide clear benefits.\n\nDotfiles: [modules/home-manager/dot-files](modules/home-manager/dot-files)\n\n## Features\n\n- Modern Nix flakes\n- [home-manager](https://github.com/nix-community/home-manager) manages dotfiles\n  - Dotfiles are kept in plain `.conf` or `.json` where possible. [Mustache](https://mustache.github.io) for templating.\n- LUKS disk encryption:\n  - [remote unlock via SSH](#remote-unlock-over-ssh)\n  - [Secure Boot](#luks-auto-unlock-with-secure-boot--tpm2) with TPM2 auto-unlock of LUKS\n- [disko](https://github.com/nix-community/disko): declarative disk partitioning with btrfs\n- [impermanence](https://github.com/nix-community/impermanence) with btrfs\n  - Filesystem wipes on reboot, keeping only folders that you explicitly persist in [your config](modules/system/nixos/headless/impermanence.nix#L84)\n  - Detect files which need persistence with `just find-impermanent`\n- Full installation happens entirely inside the NixOS ISO (works on machines with small memory)\n- [sops-nix](https://github.com/Mic92/sops-nix) manages secrets\n- Btrfs snapshots for backup and recovery of user data\n- `.justfile` contains useful aliases for frequent `nix` commands\n\n## Folder structure\n\nConfiguration works simply by importing `.nix` files. There is minimal Nix conditionals / logic - just import files with features you want on your machine.\n\nConfiguration is split onto folders:\n\n- `headless/` - CLI-only, server environments\n- `graphical/` - Desktop with GUI\n- `optional/` - Opt-in features requiring explicit import the machine's `configuration.nix`.\n- `shared/` - Cross-platform configs (works on both NixOS and macOS)\n\n```\n├── flake.nix                 # Entry point - defines all machines in nixosConfigurations\n├── vars.nix                  # Shared variables (username, etc.)\n├── .justfile                 # Run `just --list` to see the commands\n│\n├── machines/                 # Per-machine configurations\n│   ├── nixos-machine-1/\n│   │   ├── configuration.nix           # Imports shared disko module\n│   │   └── hardware-configuration.nix\n│   └── mac-1/\n│       ├── configuration.nix\n│       └── hardware-configuration.nix  \n│\n├── modules/\n│   ├── system/               # System-level configurations\n│   │   ├── shared/           # Cross-platform system configs\n│   │   │   ├── headless/\n│   │   │   └── graphical/\n│   │   ├── nixos/            # NixOS-specific system configs\n│   │   │   ├── headless/\n│   │   │   │   └── optional/\n│   │   │   └── graphical/\n│   │   │       └── optional/\n│   │   └── mac/              # Mac-specific system configs\n│   │\n│   └── home-manager/         # User-level configurations\n│       ├── dot-files/        # Raw config files (nvim, tmux, etc.)\n│       ├── shared/           \n│       │   ├── headless/     \n│       │   └── graphical/    \n│       ├── nixos/            # NixOS-specific home-manager configs\n│       │   ├── headless/\n│       │   └── graphical/\n│       └── mac/              # Mac-specific home-manager configs\n│\n├── .sops.yaml                # sops-nix secrets configuration \n├── secrets/                  # Encrypted secrets (via sops-nix)\n└── utils/                    # Utilities\n```\n\n## Getting started \n\nCheck [vars.nix](./vars.nix) and update your username, public keys etc.\n\n## Installation - NixOS (Linux)\n\n▶️ **[Video walkthrough of the installation process](https://www.youtube.com/watch?v=Iyz4PolCPPY)**\n\n### Boot Nix ISO and enable SSH\n\nDownload the minimal (or graphical) ISO for your platform from the official [NixOS website](https://nixos.org/download/#nixos-iso). \n\nBoot from the ISO, then set a password to enable SSH:\n\n```bash\npasswd\n```\n\nFind the IP address:\n\n```bash\nip addr show\n```\n\nOn your local machine where you've checked out this repo, set the ISO IP and confirm SSH access:\n\n```bash\nexport ISO_IP=\"192.168.1.XXX\"\nssh nixos@$ISO_IP\n```\n\n### Create a new Machine\n\nEach NixOS machine has the following structure:\n\n```\nmachines/<machine-name>/\n├── configuration.nix           # Machine config\n└── hardware-configuration.nix  # Auto-generated hardware config\n```\n\n#### Create `hardware-configuration.nix`\n\nEvery machine needs a `machines/<machine-name>/hardware-configuration.nix`\n\nYou can generate hardware configuration directly from the live ISO:\n\n```bash\nssh nixos@$ISO_IP \"sudo nixos-generate-config --no-filesystems && cat /etc/nixos/hardware-configuration.nix\"\n```\nCopy the configuration to: `machines/<machine-name>/hardware-configuration.nix` on your local machine.\n\nCommit and push it to git.\n\n#### Create `configuration.nix`\n\n1. **Copy an existing configuration** as a starting point:\n   - Example: [um790/configuration.nix](machines/nixos/x86_64/um790/configuration.nix)\n\n2. **Import the disko module** with your disk configuration:\n   ```nix\n   (import ../../../../modules/system/nixos/headless/disko.nix {\n     device = \"/dev/nvme0n1\";        # Your primary disk device (find with: lsblk)\n     resumeOffset = \"533760\";        # For hibernate support (get with: btrfs inspect-internal map-swapfile -r /.swapvol/swapfile)\n     swapSize = \"16G\";               # Swap file size (see https://itsfoss.com/swap-size)\n     isSsd = true;                   # Enable SSD optimizations\n   })\n   ```\n\n   **Finding your device name:**\n   ```bash\n   ssh nixos@$ISO_IP \"lsblk\"  # List all block devices from the NixOS ISO\n   # Common device names: /dev/nvme0n1 (NVMe SSD), /dev/sda (SATA/SCSI), /dev/vda (VM)\n   ```\n\n3. **Import a base module** depending on your machine type:\n   - [`modules/system/nixos/headless`](modules/system/nixos/headless/default.nix) — for server machines\n   - [`modules/system/nixos/graphical`](modules/system/nixos/graphical/default.nix) — for GUI machines (includes headless features)\n\n4. **Add optional features** as needed:\n   - Example: `modules/system/nixos/headless/optional/thunderbolt.nix`\n\n### Install\n\nThe install happens directly from the live ISO. It does not require a large amount of RAM to work. \n\nDuring the install you'll be prompted to set a password for your user and for LUKS encryption:\n\n```bash\n# Using public repository without token (if already authenticated)\nscp scripts/clone-and-install.sh nixos@$ISO_IP:/tmp/ && \\\n  ssh nixos@$ISO_IP \"/tmp/clone-and-install.sh richardgill/nix\"\n```\n\n```bash\n# Using private repository with github token\nscp scripts/clone-and-install.sh nixos@$ISO_IP:/tmp/ && \\\n  ssh nixos@$ISO_IP \"/tmp/clone-and-install.sh richardgill/nix-private $(gh auth token)\"\n```\n\n### macOS\n\nOn macOS, first install the [Determinate Systems Nix installer](https://docs.determinate.systems/):\n\nThen install the configuration:\n\n```bash\nnix-shell -p git gh just\ngh auth login\ngh repo clone nix-private\ncd nix-private\njust mac-install\n```\n\nPlace your sops key in `~/.config/sops/age/keys.txt` (retrieve from 1Password).\n\nRebuild with `just switch`.\n\n**Additional macOS setup:**\n- Go to System Settings → Keyboard → Keyboard Shortcuts and disable conflicting shortcuts\n- If Homebrew casks are blocked, go to System Settings → Privacy & Security and click \"Open Anyway\"\n\n## Useful commands\n\nInstall `just` to access the simple aliases below.\n\n### Locally deploy changes\n\n```bash\njust switch\n```\n\n## Setup LUKS\n\nBy default you can unlock LUKS locally\n\n### Remote unlock over SSH\n\n```bash\nssh root@<machine-ip> -p 2222\n```\n\nYou'll be prompted to enter the LUKS passphrase. The machine will continue booting and you can SSH normally: \n\n```bash\nssh username@<machine-ip> \n```\n\nConfiguration: [remote-unlock.nix](modules/system/nixos/headless/remote-unlock.nix)\n\n## LUKS auto unlock with Secure Boot + TPM2\n\nImport [modules/system/nixos/headless/optional/secure-boot.nix](modules/system/nixos/headless/optional/secure-boot.nix) in your machine's `configuration.nix`, then follow the setup instructions in that file.\n\n## Impermanence\n\nThis configuration uses btrfs with impermanence, where the root filesystem is reset on every boot. Only explicitly declared files and directories in `/persistent` survive reboots.\n\nWhen adding new persistence directories/files, they need to be added in `modules/system/nixos/headless/impermanence.nix` (for actual persistence)\n\n### Find impermanent files\n\nFind files that have been written in ephemeral storage but aren't in your impermanence config:\n\n```bash\njust find-impermanent\n```\n\n### Switching fails\n\nIf switching to latest version fails with \"Path X already exists\", move conflicting files to persistence first:\n\n```bash\nsudo mkdir -p /persistent/home/$USER/<folder>\nsudo mv /home/$USER/<file> /persistent/home/$USER/<folder>/\nsudo chown -R $USER:users /persistent/home/$USER/<folder>\njust build\n```\n\n## Directly Editable Configs (Out-of-Store Symlinks)\n\nSome configs (like nvim) are symlinked directly to the repo rather than the Nix store, so edits take effect immediately without rebuilding.\n\nTo make a config directly editable, use `mkOutOfStoreSymlink` in `modules/home-manager/shared/headless/dot-files.nix`:\n\n```nix\n\".config/nvim\".source =\n  config.lib.file.mkOutOfStoreSymlink \"${homeDir}/code/nix-private/modules/home-manager/dot-files/nvim\";\n```\n\nFor directories where only some files need to be mutable, use the `sourceDirectory` helper with `outOfStoreSymlinks`:\n\n```nix\n(sourceDirectory {\n  target = \".config/example\";\n  source = ../../dot-files/example;\n  outOfStoreSymlinks = [ \"mutable-file.json\" ];\n})\n```\n\n## Acknowledgments\n\n- [eh8/chenglab](https://github.com/eh8/chenglab) - Primary inspiration for this configuration structure\n- [Omarchy](https://omarchy.org/) - Opinionated Linux setup inspiration\n- [dbeley/nixos-config](https://github.com/dbeley/nixos-config) - Btrfs impermanence implementation\n- [Misterio77/nix-starter-configs](https://github.com/Misterio77/nix-starter-configs) - Initial starter configuration\n- [Great beginner friendly introduction to NixOS and flakes](https://nixos-and-flakes.thiscute.world/)\n\n",
  "installCommand": "git clone https://github.com/richardgill/nix ~/.claude/skills/nix",
  "defaultBranch": "main",
  "hasMarketplaceJson": false,
  "skillPath": "README.md"
}